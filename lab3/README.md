# Lab3 Report

##### 谢新格 PB19081644

#### 1、以换行为分隔符的消息分割

在三个程序中，每次`recv`最多1000个字节，存到buffer中。一次`recv`后，buffer中可能有多个`\n`或者一个`\n`也没有。检测buffer中有无`\n`，并不断的将buffer进行`strcpy`到预设的消息字符串msg中，若无`\n`则会继续`recv`，直至检测到`\n`，一旦msg中有了第一个`\n`，就进行`send`。

#### 2、处理可能的 `send` 阻塞

设置剩余要发送信息的长度`remain`和已发送信息的长度`sended`，用 `send` 的返回值更新这两个数据，当`remain > 0`时，说明没发完，将要发送的信息改为原来字符串的对应子串再重新发送。

实际上，对于阻塞情形，`send`会将要发送的信息全部拷贝到内核的发送缓冲区中才返回，在返回前当前线程内的`recv`并不会被执行，不会发生发送不完的情况。

#### 3、利用多线程技术实现多人聊天室

每个线程拥有一个独立的接受信息缓冲，当一个线程要发生信息时，会将全局的 `mutex` 锁住，向其他所有的客户端依次发送消息，全部发送后，再解锁。

用户退出时，线程能检测到用户退出，将该用户的套接字关闭，线程退出，释放资源。

#### 4、利用 IO 复用 / 异步 IO 技术实现多人聊天室

使用 `select`  返回时，有三种情况，一是有新的连接，使用`accept`；二是有用户退出，处理同多线程；三是找到了可接收的套接字，进入消息的处理，用2中的方式完成向其他所有客户端`send`之后，当确认到`recv`的返回值为0时，才等待下一次`select`。

